import e from"megajs2/src/util.js";import t from"megajs2/src/mega-util.js";import{Semaphore as r}from"megajs2/src/synchronization.js";import s from"megajs2/src/grouped-tasks.js";class i{static base64ToBinaryString(e){try{return atob(e)}catch(t){throw console.error("Incorrect Base64:",e),t}}static binaryStringToBase64(e){return btoa(e)}static arrayBufferToUtf8String(e){return(new TextDecoder).decode(e)}static arrayBufferToBinaryString(e){return e.reduce((e,t)=>e+String.fromCharCode(t),"")}static binaryStringToArrayBuffer(e){const t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}static base64ToArrayBuffer(e){const t=i.base64ToBinaryString(e);return i.binaryStringToArrayBuffer(t)}static arrayBufferToBase64(e){const t=i.arrayBufferToBinaryString(e);return i.binaryStringToBase64(t)}static arrayBufferToHexString(e){const t=i.ByteToHexTable.get(),r=new Uint8Array(e.buffer),s=new Array(r.length);for(let e=0;e<r.length;e++)s[e]=t[r[e]];return s.join("")}static ByteToHexTable=class{static get(){const e=i.ByteToHexTable;return e.inited||e.init(),e.byteToHex}static byteToHex=[];static inited=!1;static init=()=>{const e=i.ByteToHexTable;for(let t=0;t<256;t++){const r=t.toString(16).padStart(2,"0");e.byteToHex.push(r)}e.inited=!0}};static arrayBufferToLong(e){if(e.length>8)throw"Length is over size of Long";const t=e.reduce((e,t,r)=>e+t*256**r,0);if(t>Number.MAX_SAFE_INTEGER)throw"Over Number.MAX_SAFE_INTEGER";return t}static secondsToFormattedString(e){const t=new Date(1e3*e);function r(e){return e.toString().padStart(2,"0")}return t.getFullYear()+"."+r(t.getMonth()+1)+"."+r(t.getDate())+" "+r(t.getHours())+":"+r(t.getMinutes())+":"+r(t.getSeconds())}static bytesToSize(e,t=2){if(0===e)return"0 B";t=t<0?0:t;const r=Math.floor(Math.log(e)/Math.log(1024));return Number.parseFloat((e/Math.pow(1024,r)).toFixed(t))+" "+["B","KB","MB","GB","TB","PB","EB","ZB","YB"][r]}static sleep(e,t=!1){return e<=0?t?i.nextEventLoopTask():Promise.resolve():new Promise(t=>setTimeout(t,e))}static nextEventLoopTask(){return new Promise(e=>{i.setImmediate(e)})}static addSearchParamsToURL(e,t){Object.entries(t).forEach(([t,r])=>{e.searchParams.append(t,r.toString())})}static async repeatIfErrorAsync(e,t=5,r=5e3){for(let s=0;;s++)try{return s&&console.log("REPEAT"),await e()}catch(e){if(console.error(e,`ERROR! Will be repeated. The try ${s+1} of ${t}.`),!(s<t))throw e;await i.sleep(r)}}static getSafeName(e){return e.includes("/")&&console.log(`Bad filename: "${e}"`),e.replace("/","_")}static compareArrays(e,t){if(e.length===t.length){for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}return!1}static stringToBase64(e,t="default"){if("default"===t){const t=unescape(encodeURIComponent(e));return i.binaryStringToBase64(t)}if("safe"===t){const t=(new TextEncoder).encode(e);return i.arrayBufferToBase64(t)}if("unsafe"===t)return i.binaryStringToBase64(e)}static base64ToString(e,t="default"){if("default"===t){const t=i.base64ToBinaryString(e);return decodeURIComponent(escape(t))}if("safe"===t){const t=i.base64ToArrayBuffer(e);return(new TextDecoder).decode(t)}if("unsafe"===t)return i.base64ToBinaryString(e)}static async*iterateReadableStream(e){const t=e.getReader();for(;;){const{done:e,value:r}=await t.read();if(e)break;yield r}}static setImmediate=globalThis.setImmediate||function(){const{port1:e,port2:t}=new MessageChannel,r=[];return e.onmessage=function(){r.shift()()},function(e){t.postMessage(null),r.push(e)}}();static structuredClone(e){return new Promise(t=>{const{port1:r,port2:s}=new MessageChannel;r.onmessage=function(e){t(e.data)},s.postMessage(e)})}}class a{static decryptAES(e,t,{iv:r,mode:s,padding:i}={}){r=r||new Uint8Array(t.length),s=s||"CBC",i=i||"Pkcs7";const a=function(e){const t=Math.trunc(e.length/4)+(e.length%4?1:0),r=new DataView(e.buffer,e.byteOffset,e.byteLength),s=new Array(t);for(let e=0;e<t;e++)s[e]=r.getInt32(4*e,!1);return CryptoJS.lib.WordArray.create(s,e.byteLength)},n=a(e),o=a(t),l=a(r);return function(e){const{words:t,sigBytes:r}=e,s=new ArrayBuffer(4*t.length),i=new DataView(s);for(let e=0;e<t.length;e++)i.setInt32(4*e,t[e],!1);return new Uint8Array(s,0,r)}(CryptoJS.AES.decrypt({ciphertext:n},o,{iv:l,mode:CryptoJS.mode[s],padding:CryptoJS.pad[i]}))}}class n{static parseEncodedNodeAttributes(e,t){const r=n.megaBase64ToArrayBuffer(e),s=a.decryptAES(r,t,{padding:"ZeroPadding"}),o=i.arrayBufferToUtf8String(s).substring("MEGA".length),{n:l,c:c}=JSON.parse(o);return{name:l,serializedFingerprint:c}}static parseFingerprint(e){const t=n.megaBase64ToArrayBuffer(e),r=t.subarray(0,16),s=t[16],a=t.subarray(17,17+s);if(s>5)throw"Invalid value: timeBytesLength = "+s;return{modificationDate:i.arrayBufferToLong(a),fileChecksum:r}}static decryptionKeyToParts(e){const t=e.subarray(16,24),r=e.subarray(24,32),s=new Uint8Array(16);for(let t=0;t<16;t++)s[t]=e[t]^e[t+16];return{iv:t,metaMac:r,key:s}}static decryptKey(e,t){const r=new Uint8Array(e.length);for(let s=0;s<e.length;s+=16){const i=e.subarray(s,s+16),n=a.decryptAES(i,t,{padding:"NoPadding"});r.set(n,s)}return r}static megaBase64ToBase64(e){const t=function(e){try{const t=(4-e.length%4)%4;if(3===t)throw{name:"IllegalArgumentException",message:"Wrong Mega Base64 string"};return t}catch(e){return 100}}(e);return(e+"=".repeat(t)).replace(/-/g,"+").replace(/_/g,"/")}static megaBase64ToArrayBuffer(e){const t=n.megaBase64ToBase64(e);return i.base64ToArrayBuffer(t)}static base64ToMegaBase64(e){return e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}static arrayBufferToMegaBase64(e){const t=i.arrayBufferToBinaryString(e),r=i.binaryStringToBase64(t);return n.base64ToMegaBase64(r)}static megaBase64ToBinaryString(e){const t=n.megaBase64ToBase64(e);return i.base64ToBinaryString(t)}static bytesToSize(e,t){if(0===e)return"0 B";const r=1024;t||(e>Math.pow(r,3)?t=2:e>Math.pow(r,2)&&(t=1));const s=Math.floor(Math.log(e)/Math.log(r));return(e/Math.pow(r,s)).toFixed(t)+" "+["B","KB","MB","GB","TB","PB","EB","ZB","YB"][s]}}class o{static encryptedName=!1;static apiGateway="https://g.api.mega.co.nz/cs";static grouped=!0;static errorRepeatCount=5;static errorRepeatDelay=5e3;static repeatIfErrorAsync(t,r=o.errorRepeatCount,s=o.errorRepeatDelay){return e.repeatIfErrorAsync(t,r,s)}static ssl=2;static semaphore=new r(16,1e3);static RequestApiGrouped=class extends s{async handle(e){const t=e.key,r=e.pull(),s=[];for(const e of r)s.push(e.getValue());const i=await o.requestApiSafe(t,s);r.forEach((e,t)=>{e.resolve(i[t])})}};static requestApiGrouped=new o.RequestApiGrouped;static async requestApi(t,r={},s=o.grouped){const i=new URL(o.apiGateway);e.addSearchParamsToURL(i,r);const a=i.toString();return s?o.requestApiGrouped.getResult({key:a,value:t}):(await o.requestApiSafe(a,[t]))[0]}static async requestApiSafe(e,t){await o.semaphore.acquire();try{const r=await o.repeatIfErrorAsync(r=>o.requestApiUnsafe(e,t));return o.apiErrorHandler(r)}finally{o.semaphore.release()}}static async requestApiUnsafe(e,t){const r=await fetch(e,{method:"post",body:JSON.stringify(t),referrerPolicy:"strict-origin-when-cross-origin"});if(500===r.status)throw Error("ERR_ABORTED 500 (Server Too Busy)");200!==r.status&&console.error("[response.status]",r.status);const s=await r.text();return JSON.parse(s)}static apiErrorHandler(e){if(Array.isArray(e))return e;throw-9===e?new Error("ERROR CODE: -9. NOT FOUND"):-16===e?new Error("ERROR CODE: -16. USER IS BLOCKED"):-3===e?new Error("ERROR CODE: -3. AGAIN"):new Error("ERROR CODE: "+e)}static async requestFileAttributeDownloadUrl({id:e,type:t}){console.log("Request download url...");return(await o.requestApi({a:"ufa",fah:e,ssl:o.ssl,r:1})).p+"/"+t}static async requestFileAttributeBytes(e,r){let s;if(Array.isArray(r)){s=new Uint8Array(8*r.length);for(let e=0;e<r.length;e++)s.set(t.megaBase64ToArrayBuffer(r[e]),8*e)}else s=t.megaBase64ToArrayBuffer(r);const i=await o.repeatIfErrorAsync(async()=>{console.log("Downloading content... ");const t=await fetch(e,{method:"post",body:s,headers:{connection:"keep-alive"},referrerPolicy:"strict-origin-when-cross-origin"});return 200!==t.status&&console.error("[response.status]",t.status),new Uint8Array(await t.arrayBuffer())});return console.log("[downloaded]",i.length,"bytes"),i}static async requestNodeInfo(e){const t=await o.requestApi({a:"g",p:e,g:1,ssl:o.ssl}),r={size:t.s,nodeAttributesEncoded:t.at,downloadUrl:t.g,timeLeft:t.tl,EFQ:t.efq,MSD:t.msd};return t.fa&&(r.fileAttributesStr=t.fa),r}static async requestFolderInfo(e){const t=await o.requestApi({a:"f",r:1,c:1,ca:1},{n:e}),{f:r,sn:s,noc:i}=t;const a=function(e){const t=e[0],r=t.k.match(/^[^:]+/)[0];return r!==t.h&&console.warn("ShareRootNodeId does not equal to id of the first node."),r}(r);function n(e){switch(e){case 0:return"file";case 1:return"folder";default:return e}}function l(e){const t=e.k;return""===t?(console.log("A missed key!",e),null):t.match(/(?<=:)[\w-_]+/)[0]}return{nodes:function(e){return e.map(e=>{const t={id:e.h,parentId:e.p,ownerId:e.u,type:n(e.t),attributes:e.a,decryptionKeyStr:l(e),creationDate:e.ts};return"file"===t.type&&(t.size=e.s,e.fa&&(t.fileAttributesStr=e.fa)),t})}(r),rootId:a}}}class l{key;first;constructor(e,t,r){this.key=e,this.first=t,this.groupedTasks=r}pull(){return this.groupedTasks.pullEntries(this.key)}parts(e){return this.groupedTasks.pullParts(this.key,e)}}class c{constructor({entryClass:e,delayStrategy:t}={}){this.entryClass=e||c.SimpleEntry,this.delayStrategy=t||c.execute.afterDelayWithMicroTask}static SimpleEntry=class{resolve;constructor(e,t,r,s){this.key=e,this.value=t,this.resolve=r,this.reject=s}getKey(){return this.key}getValue(){return this.value}needHandle(){return!0}getResult(){throw"SimpleEntry.getResult() method does not implemented"}};queue=new Map;getResult({key:e,value:t}){return new Promise((r,s)=>{const i=new this.entryClass(e,t,r,s);i.needHandle()?this.enqueue(i):r(i.getResult())})}enqueue(e){const t=e.getKey();this.queue.has(t)||(this.queue.set(t,[]),this.delayStrategy(()=>{this.handle(new l(t,e,this)).catch(e.reject)})),this.queue.get(t).push(e)}pullEntries(e){const t=this.queue.get(e);return this.queue.delete(e),t}*pullParts(e,t){const r=this.pullEntries(e);if(t){let e=0;for(;e<r.length;)yield r.slice(e,e+t),e+=t}else yield r}async handle(e){}static execute=class{static now(e){e()}static afterDelayWithMicroTask(e){Promise.resolve().then(e)}static afterDelayWithEventLoop(e){setImmediate?setImmediate(e):setTimeout(e,0)}static afterDelay(e,t=0){setTimeout(e,t)}}}class d{constructor(e=1,t=0){this.limit=e,this.delay=t}active=0;pending=[];completeTimes=[];async acquire(){if(this.isDisabled)return;const e=this.completeTimes.length;if(e>0&&e===this.limit-this.active){const t=this.delay-(performance.now()-this.completeTimes.shift());console.log("completed: "+e+", active: "+this.active+", wait: "+t),await i.sleep(t)}if(!(this.active<this.limit))return new Promise(e=>{this.pending.push(e)});this.active++}release(){this._release().then()}async _release(){if(!this.isDisabled)if(this.active>0)if(this.active--,this.pending.length>0){const e=this.pending.shift();this.active++,await i.sleep(this.delay),e()}else this.delay>0&&this.completeTimes.push(performance.now());else console.warn("[Semaphore] over released")}async sync(e){try{return await this.acquire(),await e()}finally{this.release()}}releaseAll(){for(;this.pending.length;){this.pending.shift()()}this.active=0,this.completeTimes=[]}_limit;_delay;set limit(e){this._limit=e<1?1:e}get limit(){return this._limit}set delay(e){this._delay=e<0?0:e}get delay(){return this._delay}isDisabled=!1;disable(e=!0){e&&this.releaseAll(),this.isDisabled=!0}enable(){this.isDisabled=!1}static disabled(e=1,t=0){const r=new d(e,t);return r.disable(),r}}class u{_count;_promise;_resolve;constructor(e=0){this._count=e,this._promise=e>0?new Promise(e=>{this._resolve=e}):Promise.resolve()}countDown(){this._count>0&&(this._count--,0===this._count&&this._resolve())}wait(){return this._promise}get released(){return this._count>0}release(){this._count=0,this._resolve()}}class y extends u{countUp(){0===this._count&&(this._promise=new Promise(e=>{this._resolve=e})),this._count++}}var h={Semaphore:d,CountDownLatch:u,CountUpAndDownLatch:y},f=Object.freeze({__proto__:null,Semaphore:d,CountDownLatch:u,CountUpAndDownLatch:y,default:h});class p{id;type;bunch;constructor(e,t,r){this.id=e,this.type=Number(t),this.bunch=g.of(Number(r))}getDownloadUrl(e=!0){return m.hasBytes(this)?this.bunch.getDownloadUrl(this,e):null}toString(){return this.bunch+":"+this.type+"*"+this.id}}class g{id;downloadUrl=null;static values=new Map;constructor(e){this.id=Number(e)}toString(){return this.id.toString()}static of(e){if(g.values.has(e))return g.values.get(e);const t=new g(e);return g.values.set(e,t),t}async getDownloadUrl(e,t=!0){if(t&&this.hasDownloadUrl)return this.downloadUrl;const r=await o.requestFileAttributeDownloadUrl(e);return this.downloadUrl=r,r}get hasDownloadUrl(){return Boolean(this.downloadUrl)}get downloadUrl(){return this.downloadUrl}}class m{static thumbnail=0;static preview=1;static hasBytes(e){return e.type===m.preview||e.type===m.thumbnail}}class w{static cached=!0;static grouped=!0;type;get type(){return this.type}constructor(e){this.type=e}static DlUrlRequests=class extends c{async handle(e){const t=e.first.getValue(),r=await t.getDownloadUrl();for(const t of e.pull())t.resolve(r)}static RequestDlUrlEntry=class extends c.SimpleEntry{needHandle(){return!this.getValue().bunch.hasDownloadUrl}getResult(){return this.getValue().bunch.downloadUrl}getKey(){return this.getValue().bunch.id}}};static dlUrlRequests=new w.DlUrlRequests({entryClass:w.DlUrlRequests.RequestDlUrlEntry,delayStrategy:c.execute.now});getDownloadUrl({fileAttribute:e,node:t},r=w.cached){const s=e||b.of(t).byType(this.type);return r?w.dlUrlRequests.getResult({value:s}):s.getDownloadUrl(!1)}static DlBytesRequests=class extends c{async handle(e){const t=e.key,r=new d(16);for(const s of e.parts(16))r.sync(()=>this.handlePart(t,s)).then()}async handlePart(e,t){const r=new Map;for(const e of t){const t=e.getValue();r.has(t)||r.set(t,[]),r.get(t).push(e.resolve)}const s=[...r.keys()],i=w.fileAttributeBytes(e,s);for await(const{id:e,dataBytes:t}of i){const s=r.get(e);for(const e of s)e(t)}}};static dlBytesRequests=new w.DlBytesRequests;async getEncryptedBytes({fileAttribute:e,downloadUrl:t,node:r},s=w.grouped){const i=e||b.of(r).byType(this.type),a=t||await this.getDownloadUrl({fileAttribute:i});if(s)return w.dlBytesRequests.getResult({key:a,value:i.id});const n=await o.requestFileAttributeBytes(a,i.id);return w.parseBytes(n).dataBytes}static async*fileAttributeBytes(e,t){const r=await o.requestFileAttributeBytes(e,t);for(let e=0,s=0;e<t.length;e++){const{id:e,dataBytes:t}=w.parseBytes(r,s);yield{id:e,dataBytes:t},s+=12+t.length}}static parseBytes(e,t=0){const r=e.subarray(t,t+8),s=e.subarray(t+8,t+12),a=i.arrayBufferToLong(s),o=e.subarray(t+12,t+12+a);return{id:n.arrayBufferToMegaBase64(r),dataBytes:o}}async getBytes({fileAttributes:e,encryptedBytes:t,node:r,downloadUrl:s}){const i=e||b.of(r),n=i.byType(this.type),o=t||await this.getEncryptedBytes({fileAttribute:n,downloadUrl:s,node:r});if(!i.nodeKey){if(b.strictMode)throw"No key specified for the file attribute decryption.";return console.log("No key specified for the file attribute decryption. Skipping the decryption."),o}return console.log("Decryption of a file attribute..."),a.decryptAES(o,i.nodeKey,{padding:"ZeroPadding"})}}class b{static strictMode=!1;fileAttributes;nodeKey;constructor(e){const t=[];e.fileAttributesStr.split("/").forEach(e=>{const r=e.match(/(?<bunch>\d+):(?<type>\d+)\*(?<id>.+)/).groups,{id:s,type:i,bunch:a}=r;t.push(new p(s,i,a))}),this.fileAttributes=t,this.nodeKey=e.key||null}toString(){return this.fileAttributes.join("/")}byType(e){return this.fileAttributes.find(t=>t.type===e)}static values=new Map;static add(e){b.values.get(e.fileAttributesStr)||b.values.set(e.fileAttributesStr,new b(e))}static get(e){return b.values.get(e.fileAttributesStr)}static of(e){return b.add(e),b.get(e)}static Thumbnail=new w(m.thumbnail);static Preview=new w(m.preview);static getThumbnail(e){return b.getAttribute(e,b.Thumbnail)}static getPreview(e){return b.getAttribute(e,b.Preview)}static getAttribute(e,t){return t.getBytes({node:e})}}class S{id;decryptionKeyStr;isFolder;selectedFolderId;selectedFileId;constructor(e){Object.assign(this,e)}toString(){return"[id]               "+this.id+"\n[decryptionKeyStr] "+this.decryptionKeyStr+"\n[isFolder]         "+this.isFolder+"\n[selectedFolderId] "+this.selectedFolderId+"\n[selectedFileId]   "+this.selectedFileId+"\n[url]              "+this.getUrl()+"\n[url-legacy]       "+this.getUrl(!0)}static isFolder(e){return S.fromUrl(e).isFolder}get selectedId(){return this.selectedFileId||this.selectedFolderId||null}static fromUrl(e){const t=e.toString();let r;r=t.match(/#F!|#!/)?/(?<type>(?<isFolder>#F!)|(?<isFile>#!))(?<id>[\w-_]+)(?<keyPrefix>!(?=[\w-_]{22,43})|!(?=[!?])|!(?![\w-_]{8}))?(?<key>(?<=!)[\w-_]{22,43})?(?<selected>((?<selectedFilePrefix>\?)|(?<selectedFolderPrefix>!?))((?<file>(?<=\?)[\w-_]+)|(?<folder>(?<=!)[\w-_]+)))?/:/(?<type>(?<isFolder>folder\/)|(?<isFile>file\/))(?<id>[\w-_]+)(?<keyPrefix>#)?(?<key>(?<=#)[\w-_]{22,43})?(?<selected>((?<selectedFilePrefix>\/file\/)|(?<selectedFolderPrefix>\/folder\/))((?<file>(?<=\/file\/)[\w-_]+)|(?<folder>(?<=\/folder\/)[\w-_]+)))?/;const s=t.match(r);if(!s)throw`Unsupported URL ("${t}")`;const{groups:i}=s,a=Boolean(i.isFolder),n=i.id,o=i.key||"",l=i.folder||"",c=i.file||"";return new S({id:n,decryptionKeyStr:o,isFolder:a,selectedFolderId:l,selectedFileId:c})}static fromParts({id:e,decryptionKeyStr:t="",isFolder:r=!1,selectedFolderId:s="",selectedFileId:i=""}){return new S({id:e,decryptionKeyStr:t,isFolder:r,selectedFolderId:s,selectedFileId:i})}getUrl(e=!1){let t;const r=e?"#F":"folder",s=e?"#":"file",i=e?"!":"/",a=e?"!":"#",n=e?"?":"/file/",o=e?"!":"/folder/";let l="";return this.selectedFileId?l=n+this.selectedFileId:this.selectedFolderId&&(l=o+this.selectedFolderId),t="https://mega.nz/"+(this.isFolder?r:s)+i+this.id+(this.decryptionKeyStr?a+this.decryptionKeyStr:"")+(l&&!this.decryptionKeyStr?a+l:l),t}}class B{[Symbol.toStringTag]="BasicFolderShareNode";constructor(e,t){if(this.id=e.id,this.parentId=e.parentId,this.parent=e.parent||null,this.ownerId=e.ownerId,this.creationDate=e.creationDate,t&&e.decryptionKeyStr){const r=n.megaBase64ToArrayBuffer(e.decryptionKeyStr);this._decryptionKey=n.decryptKey(r,t)}else this._decryptionKey=null}type;id;parentId;parent;ownerId;creationDate;_decryptionKey;get key(){return this._decryptionKey}name;get path(){return this.parent?[...this.parent.path,this.parent.name]:[]}get root(){return"rootFolder"===this.parent.type?this.parent:this.parent.root}}class T extends B{[Symbol.toStringTag]="FileNode";constructor(e,t){if(super(e,t),this.type="file",this.size=e.size,t&&e.decryptionKeyStr){const{name:t,serializedFingerprint:r}=n.parseEncodedNodeAttributes(e.attributes,this.key);this.name=t;const{modificationDate:s,fileChecksum:i}=n.parseFingerprint(r);this.modificationDate=s}else this.modificationDate=null,this.name=_(e.attributes,!0)}size;_keyParts;get key(){return this._keyParts||(super.key?this._keyParts=n.decryptionKeyToParts(super.key):this._keyParts={iv:null,metaMac:null,key:null}),this._keyParts.key}modificationDate;get mtime(){return this.modificationDate}get modificationDateFormatted(){return i.secondsToFormattedString(this.modificationDate)}get downloadUrl(){return null}}class A extends T{[Symbol.toStringTag]="MediaFileNode";constructor(e,t){super(e,t),this.type="mediaFile",this.fileAttributesStr=e.fileAttributesStr}fileAttributesStr;getThumbnail(){return b.getThumbnail(this)}getPreview(){return b.getPreview(this)}get thumbnail(){return b.of(this).byType(b.Thumbnail.type)}get preview(){return b.of(this).byType(b.Preview.type)}}class F extends B{[Symbol.toStringTag]="FolderNode";constructor(e,t){if(super(e,t),this.type="folder",t){const{name:t}=n.parseEncodedNodeAttributes(e.attributes,this.key);this.name=t}else this.name=_(e.attributes,!1)}folders=[];files=[];_size=0;get size(){return this._size}}class D extends F{get[Symbol.toStringTag](){return"RootFolderNode"}constructor(e,t){super(e,t),this.type="rootFolder"}get root(){return this}}class v{[Symbol.toStringTag]="SharedFileNode";constructor(e,t){if(this.type="sharedFile",this.id=e.id,e.decryptionKeyStr){const t=n.megaBase64ToArrayBuffer(e.decryptionKeyStr),{iv:r,metaMac:s,key:i}=n.decryptionKeyToParts(t);this.key=i}else this.key=null;const{size:r,nodeAttributesEncoded:s,downloadUrl:i,timeLeft:a}=t;if(this.size=r,this._meta={downloadUrl:i,timeLeft:a},e.decryptionKeyStr){const{name:e,serializedFingerprint:t}=n.parseEncodedNodeAttributes(s,this.key),{modificationDate:r,fileChecksum:i}=t?n.parseFingerprint(t):{};this.name=e,this.modificationDate=r}else this.modificationDate=null,this.name=_(s,!1)}type;id;size;key;name;modificationDate;get mtime(){return this.modificationDate}get modificationDateFormatted(){return i.secondsToFormattedString(this.modificationDate)}_meta;get timeLeft(){return this._meta.timeLeft}get downloadUrl(){return this._meta.downloadUrl}}class E extends v{[Symbol.toStringTag]="SharedMediaFileNode";constructor(e,t){super(e,t),this.type="sharedMediaFile",this.fileAttributesStr=t.fileAttributesStr}fileAttributesStr;getThumbnail(){return b.getThumbnail(this)}getPreview(){return b.getPreview(this)}}class U{static async of(e){const t=S.fromUrl(e);return t.isFolder?U.getFolderNodes(t):U.getSharedNode(t)}static async node(e){const t=S.fromUrl(e);if(t.isFolder){const e=await U.getFolderNodes(t);return e.selected?e.selected:e.root}return U.getSharedNode(t)}static async nodes(e){const t=S.fromUrl(e);return t.isFolder?U.getFolderNodes(t):[await U.getSharedNode(t)]}static async getSharedNode(e){const t=await o.requestNodeInfo(e.id);return t.fileAttributesStr?new E(e,t):new v(e,t)}static async getFolderNodes(e){const t=e.decryptionKeyStr?n.megaBase64ToArrayBuffer(e.decryptionKeyStr):null,{nodes:r,rootId:s}=await o.requestFolderInfo(e.id),i=new Map,a=[];for(let e=0;e<r.length;e++){const n=r[e];let o;n.parent=i.get(n.parentId),"file"===n.type?(o=n.fileAttributesStr?new A(n,t):new T(n,t),a.push(o),i.get(o.parentId).files.push(o)):"folder"===n.type&&(n.id===s?o=new D(n,t):(o=new F(n,t),i.get(o.parentId).folders.push(o)),i.set(n.id,o)),r[e]=null}const l=[...i.values(),...a],c=i.get(s),d=l.find(t=>t.id===e.selectedId);return Object.defineProperty(l,"root",{get:()=>c}),Object.defineProperty(l,"selected",{get:()=>d}),Object.defineProperty(l,"folders",{get:()=>[...i.values()]}),Object.defineProperty(l,"files",{get:()=>a}),l}static isMediaNode(e){return"sharedMediaFile"===e.type||"mediaFile"===e.type}}function _(e,t){if(!o.encryptedName)return null;let r=Math.trunc(3*e.length/4)-19;return t&&(r-=28),r-=1,r<0&&(r=16),console.log(r),"â–ˆ".repeat(r)}const I=U.nodes,R=U.node;export{w as FileAttributeBytes,b as FileAttributes,o as MegaApi,n as MegaUtil,U as Nodes,S as Share,f as Synchronization,i as Util,R as node,I as nodes};
//# sourceMappingURL=_mega.pure.es.min.js.map